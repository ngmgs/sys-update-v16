{{- define "main" }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
</header>

<div id="my-search-container">
    <input id="mySearchInput" autofocus 
           placeholder="{{ .Params.placeholder | default "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." }}" 
           aria-label="search" type="search" autocomplete="off" 
           style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 1px solid var(--border); background: var(--entry); color: var(--primary);">
    <ul id="mySearchResults" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
window.addEventListener('load', () => {
    let fuse;
    let allResults = [];
    let currentDisplayCount = 10;
    let isLoading = false;
    let searchTimeout;
    const input = document.getElementById('mySearchInput');
    const list = document.getElementById('mySearchResults');

    const sentinel = document.createElement('div');
    sentinel.id = 'search-sentinel';
    sentinel.style.cssText = 'text-align:center; padding:20px; color:#666; font-size:14px; display:none;';
    list.parentNode.insertBefore(sentinel, list.nextSibling);

    // URLã®æœ«å°¾ã«ãƒ“ãƒ«ãƒ‰æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆUnixæ™‚é–“ï¼‰ã‚’è‡ªå‹•ã§æŒ¿å…¥ã—ã¾ã™
    fetch('../index.json?v={{ now.Unix }}')
        .then(res => res.json())
        .then(data => {
            const cleanData = data.filter(item => item.title).sort((a, b) => {
                return new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/'));
            });
            fuse = new Fuse(cleanData, { 
                keys: ['title', 'summary'], 
                threshold: 0.1, 
                shouldSort: false,
                includeMatches: true 
            });

            // ã€å¾©å…ƒã€‘URLã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰çŠ¶æ…‹ã‚’æˆ»ã™
            const params = new URLSearchParams(window.location.search);
            const savedQuery = params.get('s');
            if (savedQuery) {
                input.value = savedQuery;
                performSearch(savedQuery, false, true);
            }
        });

    function highlight(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark style="background:none; color:#ffb300; font-weight:bold; padding:0;">$1</mark>');
    }

    function renderItem(result, query) {
        const item = result.item;
        return `
            <li style="position: relative; margin-bottom: 20px; padding: 15px; background: var(--entry); border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center;">
                ${item.image ? `<img src="${item.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px;">` : ''}
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">${highlight(item.title, query)}</h3>
                    <p style="margin: 0 0 5px 0; font-size: 0.75rem; color: var(--secondary); opacity: 0.8;">ğŸ“… ${item.date}</p>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--secondary);">${highlight(item.summary, query)}</p>
                </div>
                <a href="${item.permalink}" style="position: absolute; inset: 0; z-index: 1;"></a>
            </li>
        `;
    }

    function performSearch(query, updateUrl = true, isRestore = false) {
        let displayLimit = 10;
        
        // ã‚¹ãƒãƒ›å¯¾ç­–ï¼šæˆ»ã£ãŸæ™‚ã ã‘ã€å‰å›è¡¨ç¤ºã—ã¦ã„ãŸä»¶æ•°ã‚’ä¸€æ°—ã«å¾©å…ƒ
        if (isRestore) {
            const savedCount = sessionStorage.getItem('search-count');
            if (savedCount) displayLimit = parseInt(savedCount);
        }

        allResults = fuse.search(query);
        currentDisplayCount = displayLimit;
        list.innerHTML = allResults.slice(0, displayLimit).map(res => renderItem(res, query)).join('');
        
        sentinel.style.display = allResults.length > displayLimit ? 'block' : (allResults.length > 0 ? 'block' : 'none');
        sentinel.textContent = allResults.length > displayLimit ? 'èª­ã¿è¾¼ã¿ä¸­...' : (allResults.length > 0 ? 'ã™ã¹ã¦ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ' : 'ä¸€è‡´ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');

        if (updateUrl) {
            const newUrl = window.location.pathname + (query ? '?s=' + encodeURIComponent(query) : '');
            window.history.replaceState(null, '', newUrl);
        }

        // ã‚¹ãƒãƒ›å¯¾ç­–ï¼šæç”»å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
        if (isRestore) {
            const scrollY = sessionStorage.getItem('search-scroll');
            if (scrollY) {
                // ã‚¹ãƒãƒ›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚é–“ã‚’è€ƒæ…®ã—ã¦å°‘ã—å¾…æ©Ÿ
                setTimeout(() => window.scrollTo(0, parseInt(scrollY)), 100);
            }
        }
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¨è¡¨ç¤ºä»¶æ•°ã‚’ä¿å­˜
    window.addEventListener('scroll', () => {
        if (input.value.trim()) {
            sessionStorage.setItem('search-scroll', window.scrollY);
            sessionStorage.setItem('search-count', currentDisplayCount);
        }
    }, { passive: true });

    input.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = input.value.trim();
        if (!query) {
            allResults = [];
            list.innerHTML = '';
            sentinel.style.display = 'none';
            window.history.replaceState(null, '', window.location.pathname);
            sessionStorage.removeItem('search-scroll');
            sessionStorage.removeItem('search-count');
            return;
        }
        searchTimeout = setTimeout(() => performSearch(query), 250);
    });

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && allResults.length > currentDisplayCount && !isLoading) {
            isLoading = true;
            const start = currentDisplayCount;
            currentDisplayCount += 10;
            const query = input.value.trim();
            const nextBatch = allResults.slice(start, currentDisplayCount);
            
            list.insertAdjacentHTML('beforeend', nextBatch.map(res => renderItem(res, query)).join(''));
            
            if (currentDisplayCount >= allResults.length) {
                sentinel.textContent = 'ã™ã¹ã¦ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ';
            }
            isLoading = false;
        }
    }, { rootMargin: '200px' });

    observer.observe(sentinel);
});
</script>
{{- end }}
